name: Build Thesis

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install TeX Live + Biber + latexmk
      - name: Install TeX Live
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-full biber latexmk

      # Compile full thesis
      - name: Compile full thesis
        run: |
          mkdir -p Thesis/output
          latexmk -pdf -interaction=nonstopmode -outdir=Thesis/output Thesis/main.tex

      # Compile each chapter
      - name: Compile chapters
        run: |
          mkdir -p Thesis/output/chapters
          for f in Thesis/Chapters/*/main.tex; do
            chapter=$(basename $(dirname $f))
            echo "â–¶ Building $chapter"
            latexmk -pdf -interaction=nonstopmode -outdir=Thesis/output/chapters "$f"
          done

      # Generate index.html
      - name: Generate index.html
        run: |
          cat > Thesis/output/index.html <<EOL
            <!DOCTYPE html>
            <html lang="en">
            <head>
            <meta charset="UTF-8">
            <title>Thesis PDFs</title>
            </head>
            <body>
            <h1>Thesis PDFs</h1>
            <ul>
                <li><a href="main.pdf">Full Thesis</a></li>
            EOL

                    for f in Thesis/output/chapters/*.pdf; do
                        fname=$(basename "$f")
                        echo "    <li><a href=\"chapters/$fname\">$fname</a></li>" >> Thesis/output/index.html
                    done

                    echo "  </ul></body></html>" >> Thesis/output/index.html

      # Deploy to GitHub Pages
      - name: Deploy PDFs to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: Thesis/output
