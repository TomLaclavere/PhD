name: Build Thesis

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install TeX Live + Biber + latexmk
      - name: Install TeX Live
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            biber \
            latexmk

      # Compile full thesis
      - name: Compile full thesis
        run: |
          mkdir -p Thesis/output
          cd Thesis
          latexmk -pdf -interaction=nonstopmode -outdir=output main.tex

      # Compile each chapter
      - name: Compile chapters
        run: |
          mkdir -p Thesis/output/chapters
          for f in Thesis/Chapters/*/main.tex; do
            chapter=$(basename $(dirname $f))
            echo "â–¶ Building $chapter"
            cd "$(dirname $f)"
            latexmk -pdf -interaction=nonstopmode -outdir=../../output/chapters main.tex
            cd ../../..
          done

      # Generate index.html
      - name: Generate index.html
        run: |
          # Start HTML
          cat > Thesis/output/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
          <meta charset="UTF-8">
          <title>Thesis PDFs</title>
          <style>
          body { font-family: sans-serif; margin: 40px; }
          h1 { color: #333; }
          ul { list-style-type: none; padding: 0; }
          li { margin: 10px 0; }
          a { 
              text-decoration: none; 
              color: #0366d6;
              padding: 8px 12px;
              border: 1px solid #e1e4e8;
              border-radius: 6px;
              display: inline-block;
              transition: background-color 0.2s;
          }
          a:hover { background-color: #f6f8fa; }
          </style>
          </head>
          <body>
          <h1>Thesis PDFs</h1>
          <ul>
          <li><a href="main.pdf">Full Thesis (main.pdf)</a></li>
          EOF

          # Add each chapter PDF
          for f in Thesis/output/chapters/*.pdf; do
            fname=$(basename "$f")
            chapter_name="${fname%.pdf}"  # Remove .pdf extension
            echo "  <li><a href=\"chapters/$fname\">$chapter_name</a></li>" >> Thesis/output/index.html
          done

          # Close HTML
          cat >> Thesis/output/index.html <<'EOF'
          </ul>
          </body>
          </html>
          EOF

      # Deploy to GitHub Pages
      - name: Deploy PDFs to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: Thesis/output
          publish_branch: gh-pages
          force_orphan: true